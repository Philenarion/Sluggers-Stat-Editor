name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      version: ${{ steps.check.outputs.version }}
      release_notes: ${{ steps.check.outputs.release_notes }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if commit is a version release
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)

          # Case-insensitive match for "version X.XX" or "version X.X.X" etc.
          if echo "$FIRST_LINE" | grep -iqE '^version\s+[0-9]+\.[0-9]+'; then
            # Extract version number
            VERSION=$(echo "$FIRST_LINE" | grep -ioE '[0-9]+\.[0-9]+[0-9.]*')
            echo "is_release=true" >> "$GITHUB_OUTPUT"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"

            # Extract release notes (everything after the first line)
            NOTES=$(echo "$COMMIT_MSG" | tail -n +2 | sed '/./,$!d')
            echo "release_notes<<EOF" >> "$GITHUB_OUTPUT"
            echo "$NOTES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"

            echo "Detected release: v$VERSION"
            echo "Release notes: $NOTES"
          else
            echo "is_release=false" >> "$GITHUB_OUTPUT"
            echo "Not a version commit, skipping release."
          fi

  build-and-release:
    needs: check-release
    if: needs.check-release.outputs.is_release == 'true'
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Run build script
        run: .\build.bat
        shell: cmd

      - name: Create zip archive
        run: |
          $version = "${{ needs.check-release.outputs.version }}"
          $folderName = "sluggers-stat-editor-v$version"
          New-Item -ItemType Directory -Path $folderName
          Copy-Item -Path "dist\*" -Destination $folderName -Recurse
          Compress-Archive -Path $folderName -DestinationPath "$folderName.zip"
        shell: pwsh

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.check-release.outputs.version }}
          name: Sluggers Stat Editor v${{ needs.check-release.outputs.version }}
          body: ${{ needs.check-release.outputs.release_notes }}
          files: sluggers-stat-editor-v${{ needs.check-release.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate index.html for GitHub Pages
        env:
          RELEASE_NOTES: ${{ needs.check-release.outputs.release_notes }}
        run: |
          $template = Get-Content index.html -Raw
          $version = "${{ needs.check-release.outputs.version }}"
          $release_name = "v$version"
          $release_notes = $env:RELEASE_NOTES
          $download_url = "https://github.com/Philenarion/Sluggers-Stat-Editor/releases/download/v$version/sluggers-stat-editor-v$version.zip"
          $html = $template -replace '{{RELEASE_NAME}}', $release_name
          $html = $html -replace '{{DOWNLOAD_URL}}', $download_url
          $html = $html -replace '{{RELEASE_NOTES}}', $release_notes.Trim()
          New-Item -ItemType Directory -Path _pages -Force
          Set-Content -Path _pages/index.html -Value $html
          Write-Host "Generated index.html for release: $release_name"
        shell: pwsh

      - name: Deploy to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_pages'

      - name: Publish to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
